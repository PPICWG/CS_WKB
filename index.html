<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Responsive Export PDF GSheet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f7fa;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .dashboard-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .dashboard-header h1 {
      margin: 0;
      font-size: 2em;
      color: #2c3e50;
    }
    .dashboard-header select, .dashboard-header button {
      font-size: 1em;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-right: 8px;
    }
    .dashboard-header button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .dashboard-header button:hover {
      background: #0056b3;
    }
    #terakhir-diperbarui {
      font-size: 1em;
      color: #555;
      background: #eef;
      padding: 8px 12px;
      border-radius: 5px;
      display: inline-block;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: #fafbfc;
    }
    th, td {
      border: 1px solid #e2e2e2;
      padding: 8px;
      text-align: left;
      font-size: 1em;
    }
    th {
      background: #f0f4fa;
      color: #2c3e50;
    }
    @media (max-width: 700px) {
      .container {
        padding: 10px;
      }
      .dashboard-header {
        flex-direction: column;
        align-items: stretch;
      }
      .dashboard-header select, .dashboard-header button {
        margin-right: 0;
        margin-bottom: 8px;
      }
      table, th, td {
        font-size: 0.95em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="dashboard-header">
      <h1>Dashboard Data GSheet</h1>
      <div>
        <label for="filterKategori">Filter Kategori:</label>
        <select id="filterKategori">
          <option value="">Semua</option>
          <!-- Opsi kategori akan diisi otomatis JS -->
        </select>
        <button id="exportPdf">Export ke PDF</button>
      </div>
    </div>
    <p id="terakhir-diperbarui">Terakhir diperbarui: -</p>
    <div style="overflow-x:auto;">
      <table id="dataTable">
        <!-- Data tabel akan diisi otomatis JS -->
      </table>
    </div>
  </div>
  <script>
    // --- KONFIGURASI GSheet ---
    const SHEET_ID = '1zpXbeEdOLVVoDvOuerU3kmz0TcAJpDZOfSECFYffYTw';
    const SHEET_NAME = 'Sheet1';
    const API_KEY = 'YOUR_GOOGLE_API_KEY'; // <--- GANTI DENGAN API KEY GOOGLE ANDA

    let allData = [];
    let filteredData = [];
    let header = [];
    let kategoriList = new Set();

    // Ambil data utama dari GSheet
    function fetchDataAndRender() {
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`)
        .then(res => res.json())
        .then(data => {
          allData = data.values || [];
          if(allData.length === 0) return;
          header = allData[0];
          // Kategori otomatis
          const idxKategori = header.indexOf('Kategori');
          kategoriList = new Set();
          allData.slice(1).forEach(row => {
            if(row[idxKategori]) kategoriList.add(row[idxKategori]);
          });
          renderKategoriOptions();
          applyFilter();
        });
    }

    // Render pilihan kategori di filter
    function renderKategoriOptions() {
      const select = document.getElementById('filterKategori');
      // Hapus yang lama
      select.innerHTML = '<option value="">Semua</option>';
      Array.from(kategoriList).sort().forEach(kat => {
        select.innerHTML += `<option value="${kat}">${kat}</option>`;
      });
    }

    // Filter data sesuai kategori
    function applyFilter() {
      const kategori = document.getElementById('filterKategori').value;
      const idxKategori = header.indexOf('Kategori');
      filteredData = allData.slice(1).filter(row => !kategori || row[idxKategori] === kategori);
      renderTable();
    }

    // Tampilkan data ke tabel
    function renderTable() {
      const table = document.getElementById('dataTable');
      let html = '<tr>' + header.map(h => `<th>${h}</th>`).join('') + '</tr>';
      html += filteredData.map(row => '<tr>' + header.map((_,i)=>`<td>${row[i]||''}</td>`).join('') + '</tr>').join('');
      table.innerHTML = html;
    }

    // Event filter
    document.getElementById('filterKategori').addEventListener('change', applyFilter);

    // Ambil data M1 untuk "terakhir diperbarui"
    function updateTerakhirDiperbarui() {
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!M1?key=${API_KEY}`)
        .then(response => response.json())
        .then(data => {
          const terakhir = data.values ? data.values[0][0] : '-';
          document.getElementById('terakhir-diperbarui').textContent = 'Terakhir diperbarui: ' + terakhir;
        })
        .catch(() => {
          document.getElementById('terakhir-diperbarui').textContent = 'Terakhir diperbarui: (Gagal ambil data)';
        });
    }

    // Export ke PDF sesuai data terfilter
    document.getElementById('exportPdf').onclick = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(16);
      doc.text('Dashboard Data GSheet', 10, y);
      y += 10;
      doc.setFontSize(10);
      doc.text(document.getElementById('terakhir-diperbarui').textContent, 10, y);
      y += 10;

      // Header tabel
      doc.setFont('helvetica','bold');
      doc.text(header.join(' | '), 10, y);
      y += 10;
      doc.setFont('helvetica','normal');

      // Data tabel
      if(filteredData.length > 0) {
        filteredData.forEach(row => {
          doc.text(header.map((_,i)=>row[i]||'').join(' | '), 10, y);
          y += 8;
          if (y > 270) { doc.addPage(); y = 20; }
        });
      } else {
        doc.text('Tidak ada data.', 10, y);
      }
      doc.save('dashboard-data.pdf');
    }

    // Inisialisasi
    fetchDataAndRender();
    updateTerakhirDiperbarui();
  </script>
</body>
</html>